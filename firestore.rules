rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Helper function to check if user is authenticated
    function isAuthenticated() {
      return request.auth != null;
    }
    
    // Helper function to check if user owns the document
    function isOwner(userId) {
      return request.auth.uid == userId;
    }
    
    // Helper function to check if user is admin
    function isAdmin() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // ==================== USERS COLLECTION ====================
    match /users/{userId} {
      // Users can only read/write their own document
      allow read: if isAuthenticated() && isOwner(userId);
      allow create: if isAuthenticated() && isOwner(userId);
      allow update: if isAuthenticated() && isOwner(userId);
      allow delete: if isAuthenticated() && isOwner(userId);
      
      // Subcollection: User addresses
      match /addresses/{addressId} {
        allow read: if isAuthenticated() && isOwner(userId);
        allow create: if isAuthenticated() && isOwner(userId);
        allow update: if isAuthenticated() && isOwner(userId);
        allow delete: if isAuthenticated() && isOwner(userId);
      }
      
      // Subcollection: Payment methods
      match /paymentMethods/{paymentId} {
        allow read: if isAuthenticated() && isOwner(userId);
        allow create: if isAuthenticated() && isOwner(userId);
        allow update: if isAuthenticated() && isOwner(userId);
        allow delete: if isAuthenticated() && isOwner(userId);
      }
      
      // Subcollection: Wishlist
      match /wishlist/{productId} {
        allow read: if isAuthenticated() && isOwner(userId);
        allow create: if isAuthenticated() && isOwner(userId);
        allow delete: if isAuthenticated() && isOwner(userId);
      }
    }

    // ==================== PRODUCTS COLLECTION ====================
    match /products/{productId} {
      // Anyone can read products
      allow read: if true;
      
      // Only admins can create/update/delete products
      allow create: if isAuthenticated() && isAdmin();
      allow update: if isAuthenticated() && isAdmin();
      allow delete: if isAuthenticated() && isAdmin();
      
      // Subcollection: Product reviews
      match /reviews/{reviewId} {
        // Anyone can read reviews
        allow read: if true;
        
        // Authenticated users can create reviews
        allow create: if isAuthenticated();
        
        // Users can only update/delete their own reviews
        allow update: if isAuthenticated() && isOwner(resource.data.userId);
        allow delete: if isAuthenticated() && isOwner(resource.data.userId);
      }
      
      // Subcollection: Product inventory
      match /inventory/{warehouseId} {
        // Only admins can read/write inventory
        allow read: if isAuthenticated() && isAdmin();
        allow write: if isAuthenticated() && isAdmin();
      }
    }

    // ==================== ORDERS COLLECTION ====================
    match /orders/{orderId} {
      // Users can read their own orders
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      
      // Users can create orders (new purchases)
      allow create: if isAuthenticated() && 
                       request.auth.uid == request.resource.data.userId &&
                       request.resource.data.createdAt == request.time &&
                       request.resource.data.status == 'pending';
      
      // Users can only update specific fields (no status changes)
      allow update: if isAuthenticated() && isOwner(resource.data.userId) &&
                       !request.resource.data.diff(resource.data).affectedKeys().hasAny(['status', 'totalAmount', 'userId', 'createdAt']);
      
      // Users cannot delete orders
      allow delete: if false;
      
      // Admins can read/update all orders
      allow read: if isAuthenticated() && isAdmin();
      allow update: if isAuthenticated() && isAdmin();
      
      // Subcollection: Order items
      match /items/{itemId} {
        allow read: if isAuthenticated() && 
                       (isOwner(get(/databases/$(database)/documents/orders/$(orderId)).data.userId) || 
                        isAdmin());
        allow write: if false; // Items are managed server-side
      }
    }

    // ==================== CARTS COLLECTION ====================
    match /carts/{userId} {
      // Users can only read/write their own cart
      allow read: if isAuthenticated() && isOwner(userId);
      allow write: if isAuthenticated() && isOwner(userId);
      
      // Subcollection: Cart items
      match /items/{itemId} {
        allow read: if isAuthenticated() && isOwner(userId);
        allow create, update, delete: if isAuthenticated() && isOwner(userId);
      }
    }

    // ==================== PAYMENTS COLLECTION ====================
    match /payments/{paymentId} {
      // Users can read their own payments
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      
      // Users can create payment records (for Cloud Functions to update)
      allow create: if isAuthenticated() && 
                       request.auth.uid == request.resource.data.userId;
      
      // Only Cloud Functions should update payment status
      allow update: if false; // Handled by backend only
      
      // Admins can read all payments
      allow read: if isAuthenticated() && isAdmin();
      
      // Users cannot delete payments (audit trail)
      allow delete: if false;
    }

    // ==================== TRANSACTIONS COLLECTION ====================
    match /transactions/{transactionId} {
      // Users can read their own transactions
      allow read: if isAuthenticated() && isOwner(resource.data.userId);
      
      // Only Cloud Functions can write
      allow write: if false;
      
      // Admins can read all transactions
      allow read: if isAuthenticated() && isAdmin();
    }

    // ==================== NOTIFICATIONS COLLECTION ====================
    match /notifications/{userId} {
      // Users can only read their own notifications
      allow read: if isAuthenticated() && isOwner(userId);
      
      // Users can update read status
      allow update: if isAuthenticated() && isOwner(userId);
      
      // Users cannot create/delete notifications (server-side only)
      allow create, delete: if false;
      
      // Subcollection: Individual notifications
      match /items/{notificationId} {
        allow read: if isAuthenticated() && isOwner(userId);
        allow update: if isAuthenticated() && isOwner(userId);
        allow create, delete: if false;
      }
    }

    // ==================== CATEGORIES COLLECTION ====================
    match /categories/{categoryId} {
      // Anyone can read categories (public product catalog)
      allow read: if true;
      
      // Only admins can manage categories
      allow create, update, delete: if isAuthenticated() && isAdmin();
    }

    // ==================== PROMOTIONS COLLECTION ====================
    match /promotions/{promotionId} {
      // Anyone can read active promotions
      allow read: if resource.data.active == true || (isAuthenticated() && isAdmin());
      
      // Only admins can manage promotions
      allow create, update, delete: if isAuthenticated() && isAdmin();
    }

    // ==================== ANALYTICS COLLECTION ====================
    match /analytics/{document=**} {
      // Only admins can read analytics
      allow read: if isAuthenticated() && isAdmin();
      
      // Cloud Functions (service accounts) can write analytics
      allow write: if request.auth == null || 
                      (isAuthenticated() && isAdmin());
    }

    // ==================== ANALYTICS DAILY METRICS ====================
    match /analytics/{metric_type}/daily/{date=**} {
      // Only admins can read daily metrics
      allow read: if isAuthenticated() && isAdmin();
      
      // Cloud Functions can write metrics
      allow write: if request.auth == null || 
                      (isAuthenticated() && isAdmin());
    }

    // ==================== SYSTEM ACTIVITIES COLLECTION ====================
    match /system_activities/{doc=**} {
      // Only admins can read system activities
      allow read: if isAuthenticated() && isAdmin();
      
      // Cloud Functions can write system activities
      allow write: if request.auth == null;
    }

    // ==================== INVENTORY LOCATIONS & REORDER SUGGESTIONS ====================
    match /inventory_locations/{locationId} {
      // Warehouse staff and admins can read locations
      allow read: if isAuthenticated() && 
                     ((get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'warehouse' ||
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin') ||
                      get(/databases/$(database)/documents/users/$(request.auth.uid)).data.warehouseLocations[locationId] == true);
      
      // Only admins can update locations
      allow write: if isAuthenticated() && isAdmin();
      
      // Reorder suggestions subcollection
      match /reorder_suggestions/{suggestionId} {
        // Warehouse staff and admins can read suggestions
        allow read: if isAuthenticated() && 
                       ((get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'warehouse' ||
                         get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'));
        
        // Cloud Functions can write suggestions
        allow write: if request.auth == null || 
                        (isAuthenticated() && (get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'warehouse' ||
                                               get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin'));
      }
    }

    // ==================== DENY ALL BY DEFAULT ====================
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
